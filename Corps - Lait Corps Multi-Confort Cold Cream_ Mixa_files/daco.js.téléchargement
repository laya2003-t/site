'use strict';const Area={MAIN:'main',MAP:'map',CLIENT_DOM:'clientdom'},moduleType={WTB:1,BT:3,VT:4};class Tracker{constructor(e,t,a){if(this._wtbConf=t,this.logHost=Utils.changeAWSEndpoint('https://trace.swaven.com/log',this._wtbConf.region),this.moduleName=(Object.entries(moduleType).find((e=>e[1]===this._wtbConf.module))||['WTB'])[0].toLowerCase(),this.trkHost=Utils.setTrackingHost(this.moduleName.toUpperCase(),this._wtbConf.region),this._urlRegExp=new RegExp('^(https?:)?//'),this._country=1===t.countries.length?t.countries[0]:null,this.customTrackingOldNaming=e.customTrackingOldNaming,this.fmt=app.isMedia?`${e.width}x${e.height}`:'awe',this._offset=a,this.session=e.session,this.template=e.templatePath,this.rfr=e.referrer,this.rfr2=e.referrer2.substring(0,2048),this.trackingPixels=e.trackingPixels,this.hasPrices=+!(!e.hasPrices||!app.displayPrices),this.test=+!(!app.test&&!e.renderContext),this.openerIdx=null,this.availReqId=null,this.hasDroppedLiveRampPixel=!1,this.dntDefault=e.dntDefault,this._dntQueue=[],this._customTrkVars=null,e.customTrkVars&&(this._customTrkVars={},Object.entries(e.customTrkVars).forEach((([e,t])=>{this._customTrkVars['cust_'+e]=t}))),this.build=e.build,this.buildName=window.location.pathname.match(/awe\/\d+.\w+\/(\w+)/)?.[1]||'',this.pageId=e.pageId,t.callbackactions&&t.callbackactions.includes('deploy')&&(t.callbackactions[t.callbackactions.indexOf('deploy')]='dploy'),app.withSafeFrame&&(this.safeFrameDetector='framework'),this.consentMap=this._buildConsentMap(t.trkcfg),Tracker.dropTag('pv',{auto:!0}),app.isMedia){const e=setTimeout((()=>{hostCom.off('awe:clicktag',t)}),2e4),t=a=>{this.clicktag=a.clicktag,Tracker.log('clicktagUpdate'),a.stop&&(hostCom.off('awe:clicktag',t),clearTimeout(e))};hostCom.on('awe:clicktag',t)}hostCom.on('awe:tracking',(e=>{if(!e.params||!e.params.event)return;e.params.area||(e.params.area=Area.CLIENT_DOM);const t=e.params.event;delete e.params.event,Tracker.dropTag(t,e.params)})),hostCom.on('awe:log',(e=>{e.params||(e.params={}),e.params.area||(e.params.area=Area.CLIENT_DOM),Tracker.log(e.params.event,e.params)})),hostCom.on('awe:dnt',(e=>{app.dnt!==e.params.enabled&&(app.dnt=e.params.enabled,app.dnt||this._flushDNT(e.params.session),app.dnt||!this._wtbConf.operator?.isLiveRampEnabled||this.hasDroppedLiveRampPixel||this._dropLiveRampPixel())})),hostCom.on('awe:consentChange',(e=>{this.consentChange(e.params)})),Tracker.ready=!0,Tracker.ref=this,this.emptyQueue(),this.dntDefault&&!app.dnt&&this._wtbConf.operator?.isLiveRampEnabled&&!this.hasDroppedLiveRampPixel&&this._dropLiveRampPixel(),window.ReportingObserver&&this._setObserver()}_setObserver(){new ReportingObserver(((e,t)=>{e.forEach((e=>{console.debug(`Triggered a ${e.type} report`);const t={reportType:e.type,cpus:navigator.hardwareConcurrency,memory:navigator.deviceMemory};for(let a in e.body)'function'!=typeof e.body[a]&&null!=e.body[a]&&(t[a]=e.body[a]);Tracker.log('report',t)}))}),{types:['deprecation','intervention','crash']}).observe()}_addPixel(e){const t=document.createElement('img');t.style.display='none',t.src=e,t.setAttribute('role','none'),t.setAttribute('alt','event-data'),t.setAttribute('title','event-data'),t.onload=function(e){e?.currentTarget?.remove()},document.body.appendChild(t)}_dropLiveRampPixel(){const e=encodeURIComponent(`wtbid=${app.wtbid}`);this._addPixel(`https://di.rlcdn.com/api/segment?pid=712896&pdata=${e}`),this.hasDroppedLiveRampPixel=!0}_dropTag(e,t){t.ts=performance.now();const a=this._getTrackingParam(e,t);let r;t.log||(r=this._getCustomTrkData(e,t),this._customTracking(e,r),this._sendEventsToGTM(e,t,r)),app.dnt?this._dntQueue.push({action:e,payload:a}):this._immediateDropTag(e,a)}_immediateDropTag(e,t){const{s_url:a,...r}=t;let o=Object.entries(r).filter((([e,t])=>null!=t&&''!==t)).map((([e,t])=>`${encodeURIComponent(e)}=${encodeURIComponent(t)}`)).join('&');a&&(o+=`&s_url=${encodeURIComponent(a)}`),o+=`&rfr2=${encodeURIComponent(this.rfr2)}`,this.rfr&&(o+=`&rfr=${encodeURIComponent(this.rfr)}`);const i='buy'===e&&navigator.sendBeacon;if(i?navigator.sendBeacon(`${this.logHost}/${e}?${o}&beacon=1`):this._addPixel(`${this.logHost}/${e}?${o}`),!t.log){i&&navigator.sendBeacon(`${this.trkHost}/post?action=${e}&${o}&beacon=1`);let t=e.replace('buy','buypx');this._addPixel(`${this.trkHost}/px.png?action=${t}&${o}`)}app.$refs.logger&&app.$refs.logger.logTrk(e,r)}_sendEventsToGTM(e,t,a){let r=this._formatGTMPayload(e,t,a);r.event&&hostCom.send('awe:sendEventToHostGTM',{payload:r})}_formatGTMPayload(e,t,a){let r={};try{'clk'===e&&t.auto?r.event='mikmak_load':'buy'===e?r.event='mikmak_checkout':'clk'!==e||t.auto?'close'===e?r.event='mikmak_close':'clktab'===e?r.event='mikmak_tab':'geoloc'===e&&(r.event='mikmak_update_location'):r.event='mikmak_product_selected','clkloc'===e&&('tel'===t.clkloc_type?r.event='mikmak_call_offline_store':r.event='mikmak_click_offline_store'),r.wtbid=this._wtbConf.Id,a.location&&(r.location_zipcode=a.location.zipCode,r.location_city=a.location.city,r.location_state=a.location.region),r.commerce_type='brand.com',r.experience_name=this._wtbConf.sourceName||this._wtbConf.name,r.account_name=this._wtbConf.operator.account?.name||'',r.subaccount_name=this._wtbConf.operator.name||'',a.product&&(r.product_gtin=a.product.ean,r.product_name=a.product.name,r.product_brand=a.product.brand,r.product_id=a.product.sourcePid,r.product_package=a.product.pkg,r.product_model=a.product.model,r.product_line=a.product.productLine,r.product_brand=a.product.brand,a.product.name2&&(r.product_variant=a.product.name2)),'buy'!==e&&'clkloc'!==e||(r.product_price=a.product.price,r.product_price_currency=a.product.currency,r.product_price_text=new Intl.NumberFormat(app.locale,{style:'currency',currency:a.product.currency,minimumFractionDigits:2}).format(a.product.price),r.retailer_id=a.retailer.id,r.retailer_name=a.retailer.name,r.store_name=a.store.name,r.store_city=a.store.location.city,r.store_zipcode=a.store.location.zipCode),'clktab'===e&&(r.tab_clicked=a.tab)}catch(e){console.error('Error formatting GTM payload',e)}return r}static dropTag(e,t={}){Tracker.ready?Tracker.ref._dropTag(e,t):Tracker.enqueue(e,t)}static log(e,t={}){t.log=1,Tracker.ready?Tracker.ref._dropTag(e,t):Tracker.enqueue(e,t)}static enqueue(e,t){Tracker._queue||(Tracker._queue=new Set),Tracker._queue.add({action:e,params:t})}dropClicktag(e){app.withSafeFrame?(this._addPixel(this.clicktag),this._dropTag('clicktag',{url:this.clicktag,trigger:e})):hostCom.send('awe:clicktag',{trigger:e})}_getTrackingParam(e,t={}){var a=app.getTrkData();let r={wtbid:this._wtbConf.Id,fmt:this.fmt,module:this.moduleName,type:'awe',v:Date.now(),lang:app.locale,opscode:this._wtbConf.opscode||'',area:t.area||Area.MAIN,pageid:this.pageId,iid:window.name,reqpid:app.eans,ct:this._country,ct_context:app.country,geocountry:this._wtbConf.geoCountry,touchpoint:this._wtbConf.touchPoint,dpr:this.hasPrices,test:this.test,template:this.template,trkOrigin:'daco',tzOffset:(new Date).getTimezoneOffset(),vue:Vue.version};if(app.isMedia&&app.layoutName&&(r.layout=app.layoutName),app.masterProductMode&&app.productGroups&&app.product&&(r.pids=app.productGroups.get(app.product).map((e=>e.ean))),'pv'!==e&&'dploy'!==e&&(t.avail?.product||app.product)&&(r.pid=t.avail?.product?.ean||app.product.ean),null!=a.avgpc&&(r.avgpc=a.avgpc),null!=a.avgdst&&(r.avgdist=a.avgdst),null!=a.nbres&&(r.nbres=a.nbres),null!=a.nbrefret&&(r.nbrefret=a.nbrefret),null!=app.appId&&(r.appid=app.appId),this.availReqId&&(r.avreqid=this.availReqId),this.session&&(r=this._setSession(r)),null!=this.openerIdx&&(r.opnIdx=this.openerIdx),this._customTrkVars&&(r=Object.assign(r,this._customTrkVars)),null!=t.outbound&&(r.outbound=+!!t.outbound,delete t.outbound),'UNAVAILABLE_COUNTRY_ERROR'===app.error&&(r.oos=1),t.avail){const e=this._getAvailParams(t.avail);Object.entries(e).forEach((([e,t])=>r[e]=t))}switch(e){case'pv':r.auto=1;break;case'dploy':r.auto=+!!t.auto,t.opnidx&&(r.opnidx=t.opnidx),t.src&&(r.src=t.src);break;case'buy':t.avail&&(t.avail.clkUrlAffiliate&&(r.clkurlaff_prgid=t.avail.retailer.affiliatePrgId),r.clkurlaff=+!!t.avail.clkUrlAffiliate,r.clkurlt=t.avail.clkUrlType),t.leadid&&(r.leadid=t.leadid),r.auto=+!!t.auto;break;case'geoloc':r.auto=0;break;case'clkloc':r.clkloc_type=t.clkloc_type||'map','retailerHome'===r.clkloc_type&&(r.rid=t.avail.retailer.id,r.rurl=t.avail.retailer.url);case'clkRoute':case'appointment':case'showmap':r.auto=+!!t.auto;break;case'clk':r.auto=+!!t.auto,r.autoSel=+!!t.autoSel;break;case'apires':r.sids=app.getStoreIds(),r.auto=1;break;case'close':r.auto=+!!t.auto;break;case'unavlbsids':r.auto=1,r.sids=t.sids;break;case'storedisplayed':r.auto=+!!t.auto,r.sids=t.sids;break;case'clkout':case'custredirect':r.auto=+!!t.auto;break;case'clicktag':r.url=t.url,r.swavenDomain=+/\/\/[^\/]+?\bswaven\b/i.test(r.url),r.trigger=t.trigger;break;case'btn':case'btn_unavailable':r.reqpid=t.reqpid,r.idx=t.idx;break;default:r=Object.assign(r,t)}return r.build=this.build,r.buildName=this.buildName,r.safeframe=+app.withSafeFrame,app.withSafeFrame&&(r.safeframeDetector=this.safeFrameDetector),r.ts=Math.floor(this._offset+t.ts),app.renderContext&&(r.renderctx=app.renderContext),app.draft&&(r.draft=1),r}_setSession(e){return this.session.ts&&(e.s_ts=this.session.ts),this.session.url&&(e.s_url=this.session.url),this.session.referrer&&(e.s_referrer=this.session.referrer),this.session.id&&(e.s_id=this.session.id),e}_getAvailParams(e){return{prc:e.price.amount,dist:e.store.distance,dlv:this._getDlvParam(e.store),sid:e.store.id,sids:app.getStoreIds(),avpid:e.product.ean,retpid:e.product.retailerPdtId}}_getDlvParam(e){return e.drive||e.collect?'driveOrCollect':e.brick?'brick':e.homeDelivery?'HD':''}_customTracking(e,t){let a=this.customTrackingOldNaming?this._getCustomTrkDataOldNaming(t):t;if(!this._wtbConf.callbackenabled||this._wtbConf.callbackactions&&0!==this._wtbConf.callbackactions.length&&!this._wtbConf.callbackactions.includes(e)||(this.trackingPixels&&this._dropClientPixels(a),hostCom.send('awe:trackingCallback',{trkData:a})),this._wtbConf.trkcfg){let t=this._wtbConf.trkcfg.actions.filter((t=>t.Code===e&&(!t.retid||t.retid===a.retailer?.id)));t.length>0&&this._serverTracking(t,a)}}_getCustomTrkData(e,t={}){const a=app.getLocation();let r={action:e,ts:Date.now(),wtbid:this._wtbConf.Id,fmt:this.fmt,type:'awe',ids:app.eans,auto:!!t.auto,location:{address:a.address,city:a.city,zipCode:a.zipCode,region:a.region,country:a.country,latitude:a.latitude,longitude:a.longitude}},o=app.product;if(app.multiOffer&&t.avail)if(app.masterProductMode){const e=app.productGroups.values();let a,r;for(;(r=e.next().value)&&(a=r.find((e=>e.ean===t.avail.product.ean)),!a););o=a}else o=app.products.find((e=>e.ean===t.avail.product.ean));null!=this.openerIdx&&(r.sticky=!(0!=this.openerIdx)),app.isMedia&&app.layoutName&&(r.layout=app.layoutName);const i=app.getTrkData();return i.nbres&&(r.resultCount=i.nbres),o&&Object.keys(o).length>0&&(r.product={id:o.id,ean:o.ean,name:Utils.removeHTML(o.name),name2:Utils.removeHTML(o.name2),pkg:Utils.removeHTML(o.pkg),brand:o.brand,model:o.model,categoryName:o.catName,sourcePid:o.sourcePid,range:o.range,productLine:o.productLine}),['buy','clkloc','clkRoute','appointment'].indexOf(e)>-1&&null!=t.avail&&(r.store={id:t.avail.store.id,name:t.avail.store.name,dlv:this._getDlvParam(t.avail.store),url:t.avail.store.url,location:{city:t.avail.store.location.city,zipCode:t.avail.store.location.zipCode,country:t.avail.store.location.country}},r.retailer={id:t.avail.retailer.id,name:t.avail.retailer.name},r.product&&(r.product.retailerPdtId=t.avail.product.retailerPdtId,r.product.price=t.avail.price.amount,r.product.currency=t.avail.price.currency)),'clktab'===e&&(r.tab=t.tab),'clkloc'===e&&(r.clklocType=t.clkloc_type),r}_getCustomTrkDataOldNaming(e){let t=Object.assign({},e);return t.compat=!0,t.resultCount&&(t.nbres=t.resultCount),t.product&&(t.prd={pid:t.product.id,ean:t.product.ean,pname:t.product.name,pname2:t.product.name2,ppckg:t.product.pkg,pbr:t.product.brand}),t.store&&t.product&&(t.store={pr:t.product.price,scity:t.store.location.city,szc:t.store.location.zipCode,country:t.store.location.country,rid:t.retailer.id,rname:t.retailer.name,rpid:t.product.retailerPdtId,sid:t.store.id,sname:t.store.name,dlv:t.store.dlv,surl:t.store.url}),t.loc={zipcode:t.location.zipCode},delete t.resultCount,delete t.product,delete t.retailer,delete t.location,t}_dropClientPixels(e){var t=this.trackingPixels[e.action];t&&(Array.isArray(t)||(t=[t]),t.forEach((t=>{this._urlRegExp.test(t)&&(t=this._replacePlaceholders(t,e,!0),app.withSafeFrame?this._addPixel(t):hostCom.send('awe:dropPixel',{url:t}))})))}_serverTracking(e,t){e.forEach((e=>{if('string'!=typeof e.value)return void console.log('Server custom tracking action defined but no value, please verify configuration in database');let a,r,o,i=!0;e.tracker&&this.consentMap&&this.consentMap.has(e.tracker)&&(a=this.consentMap.get(e.tracker),i=a.accepted),this._urlRegExp.test(e.value)?(o='url',r=this._replacePlaceholders(e.value,t,!0)):(o='script',r=this._replacePlaceholders(e.value,t,!1)),i?this._dropServerTracking({[o]:r}):a.queue.push({[o]:r})}))}_dropServerTracking(e){e.url?app.withSafeFrame?this._addPixel(e.url):hostCom.send('awe:dropPixel',e):e.script&&hostCom.send('awe:addScript',e)}_replacePlaceholders(e,t,a){return null==t||(this.customTrackingOldNaming?Object.entries(t).forEach((([t,r])=>{if('object'!=typeof r||Array.isArray(r)){let o=new RegExp(`{{${t}}}`,'g');e=e.replace(o,a?encodeURIComponent(r):r)}else e=this._replacePlaceholders(e,r,a)})):e=e.replace(/{{(.+?)}}/g,((e,r)=>{const o=r.split('.');let i=t;try{for(let e=0;e<o.length;e++)i=i[o[e]];return null==i?'':a?encodeURIComponent(i.toString()):i.toString()}catch(t){return e}}))),e}emptyQueue(){if(Tracker._queue){for(let e of Tracker._queue)Tracker._queue.delete(e),this._dropTag(e.action,e.params);delete Tracker._queue}}_flushDNT(e){for(e&&(this.session=e);this._dntQueue.length>0;){let{action:t,payload:a}=this._dntQueue.shift();a.flush=1,e&&(a=this._setSession(a)),this._immediateDropTag(t,a)}}_buildConsentMap(e){if(e&&e.actions){const t=new Map;return e.actions.forEach((e=>{e.consent&&e.tracker&&(t.has(e.tracker)||t.set(e.tracker,{accepted:!1,queue:[]}))})),t.size?t:null}}consentChange({tracker:e,consent:t}){const a=this.consentMap&&this.consentMap.get(e);if(!a){const t=`No data for tracker ${e} in consentMap`;return console.error(t),void Tracker.log('error',{msg:t})}if(a.accepted=!!t,a.accepted&&a.queue.length){for(let e of a.queue)this._dropServerTracking(e);a.queue=[]}}}Tracker.ready=!1;
//# sourceMappingURL=daco.js.map
